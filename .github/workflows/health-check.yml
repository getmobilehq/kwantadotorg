name: Production Health Check

on:
  schedule:
    # Run health checks every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Application Health
        run: |
          echo "üè• Checking application health..."
          
          # Check main application
          if curl -f -s --max-time 30 https://kwanta.org/api/health > /dev/null; then
            echo "‚úÖ Main application is healthy"
          else
            echo "‚ùå Main application health check failed"
            exit 1
          fi
          
          # Check response time
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://kwanta.org)
          echo "‚è±Ô∏è Response time: ${RESPONSE_TIME}s"
          
          # Alert if response time is too slow (>5 seconds)
          if (( $(echo "$RESPONSE_TIME > 5" | bc -l) )); then
            echo "‚ö†Ô∏è Slow response time detected: ${RESPONSE_TIME}s"
          fi
      
      - name: Check API Endpoints
        run: |
          echo "üîç Checking critical API endpoints..."
          
          # Test health endpoint
          if curl -f -s https://kwanta.org/api/health | grep -q "ok"; then
            echo "‚úÖ Health API endpoint is working"
          else
            echo "‚ùå Health API endpoint failed"
            exit 1
          fi
      
      - name: Website Accessibility Check
        run: |
          echo "‚ôø Basic accessibility check..."
          
          # Check if main page loads
          MAIN_PAGE=$(curl -s https://kwanta.org)
          
          if echo "$MAIN_PAGE" | grep -q "<title>"; then
            echo "‚úÖ Main page loads with title"
          else
            echo "‚ùå Main page failed to load properly"
            exit 1
          fi
          
          if echo "$MAIN_PAGE" | grep -q "Football Match Organizer\|Kwanta"; then
            echo "‚úÖ Main content is present"
          else
            echo "‚ùå Main content missing"
            exit 1
          fi
      
      - name: Report Status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ All health checks passed"
            echo "üåê https://kwanta.org is healthy"
          else
            echo "‚ùå Some health checks failed"
            echo "üö® Manual investigation may be required"
          fi

  # Security Headers Check
  security-headers:
    name: Security Headers Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Security Headers
        run: |
          echo "üîí Checking security headers..."
          
          HEADERS=$(curl -I -s https://kwanta.org)
          
          # Check for important security headers
          if echo "$HEADERS" | grep -i "x-frame-options"; then
            echo "‚úÖ X-Frame-Options header present"
          else
            echo "‚ö†Ô∏è X-Frame-Options header missing"
          fi
          
          if echo "$HEADERS" | grep -i "x-content-type-options"; then
            echo "‚úÖ X-Content-Type-Options header present"
          else
            echo "‚ö†Ô∏è X-Content-Type-Options header missing"
          fi
          
          if echo "$HEADERS" | grep -i "strict-transport-security"; then
            echo "‚úÖ HSTS header present"
          else
            echo "‚ö†Ô∏è HSTS header missing"
          fi
          
          echo "üìã Full headers check completed"